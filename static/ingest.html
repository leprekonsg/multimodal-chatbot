<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Ingestion</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-deep: #0A0A0C;
            --bg-primary: #111114;
            --bg-elevated: #1A1A1E;
            --bg-hover: #222228;
            
            --accent-primary: #D4A574;
            --accent-glow: rgba(212, 165, 116, 0.15);
            --accent-muted: #8B7355;
            
            --sage: #6B8B6B;
            --sage-muted: #4A634A;
            --coral: #C17B7B;
            
            --text-primary: #F5F0E6;
            --text-secondary: #A39B8B;
            --text-muted: #6B6560;
            
            --border-subtle: rgba(245, 240, 230, 0.08);
            --border-accent: rgba(212, 165, 116, 0.3);
            
            --font-display: 'Crimson Pro', Georgia, serif;
            --font-mono: 'IBM Plex Mono', monospace;
            
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-mono);
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-deep);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at 50% 0%, rgba(212, 165, 116, 0.03) 0%, transparent 60%);
        }
        
        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-primary);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-mark {
            width: 32px;
            height: 32px;
            border: 2px solid var(--accent-primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display);
            font-weight: 600;
            color: var(--accent-primary);
        }
        
        .logo-text {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }
        
        .nav-link:hover {
            color: var(--accent-primary);
            background: var(--bg-elevated);
        }
        
        /* Main Container */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .page-title {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .page-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }
        
        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--border-accent);
            border-radius: var(--radius-xl);
            padding: 3rem;
            text-align: center;
            background: var(--bg-primary);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--accent-primary);
            background: var(--accent-glow);
        }
        
        .upload-zone.dragover {
            transform: scale(1.01);
        }
        
        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            stroke: var(--accent-primary);
            opacity: 0.8;
        }
        
        .upload-title {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .upload-subtitle {
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        .upload-formats {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }
        
        .format-tag {
            padding: 0.25rem 0.75rem;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .file-input {
            display: none;
        }
        
        /* Text Input Section */
        .section {
            margin-top: 2rem;
        }
        
        .section-title {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .text-input-container {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .text-input-header {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .text-input-header input {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 0.5rem 0.75rem;
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 13px;
        }
        
        .text-input-header input::placeholder {
            color: var(--text-muted);
        }
        
        .text-input-header input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        .text-area {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 14px;
            line-height: 1.7;
            resize: vertical;
        }
        
        .text-area::placeholder {
            color: var(--text-muted);
        }
        
        .text-area:focus {
            outline: none;
        }
        
        .text-input-footer {
            display: flex;
            justify-content: flex-end;
            padding: 0.75rem 1rem;
            background: var(--bg-elevated);
            border-top: 1px solid var(--border-subtle);
        }
        
        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-md);
            font-family: var(--font-mono);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .btn-primary {
            background: var(--accent-primary);
            color: var(--bg-deep);
        }
        
        .btn-primary:hover {
            background: var(--text-primary);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border-subtle);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        /* Queue */
        .queue {
            margin-top: 2rem;
        }
        
        .queue-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        
        .queue-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            margin-bottom: 0.75rem;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .queue-item-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: var(--bg-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .queue-item-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--accent-primary);
        }
        
        .queue-item-icon.image svg { stroke: var(--sage); }
        .queue-item-icon.pdf svg { stroke: var(--coral); }
        
        .queue-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .queue-item-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .queue-item-meta {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .queue-item-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 12px;
        }
        
        .status-pending { color: var(--text-muted); }
        .status-processing { color: var(--accent-primary); }
        .status-done { color: var(--sage); }
        .status-error { color: var(--coral); }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-subtle);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .queue-item-remove {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .queue-item-remove:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        /* Progress Bar */
        .progress-bar {
            height: 3px;
            background: var(--bg-elevated);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--accent-primary);
            transition: width 0.3s ease;
        }
        
        /* Recent Documents */
        .recent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .recent-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .recent-card:hover {
            border-color: var(--border-accent);
            transform: translateY(-2px);
        }
        
        .recent-card-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background: var(--bg-elevated);
        }
        
        .recent-card-content {
            padding: 1rem;
        }
        
        .recent-card-type {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-primary);
            margin-bottom: 0.25rem;
        }
        
        .recent-card-title {
            font-family: var(--font-display);
            font-weight: 600;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .recent-card-caption {
            font-size: 12px;
            color: var(--text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
        
        .toast {
            padding: 1rem 1.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            margin-top: 0.5rem;
            animation: toastIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .toast.success { border-color: var(--sage-muted); }
        .toast.error { border-color: var(--coral); }
        
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-mark">K</div>
            <span class="logo-text">Knowledge Ingestion</span>
        </div>
        <a href="/" class="nav-link">‚Üê Back to Chat</a>
    </header>
    
    <main class="container">
        <h1 class="page-title">Add to Knowledge Base</h1>
        <p class="page-subtitle">Upload documents, images, or paste text to expand your searchable knowledge.</p>
        
        <!-- Upload Zone -->
        <div class="upload-zone" id="uploadZone">
            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            <div class="upload-title">Drop files here or click to browse</div>
            <div class="upload-subtitle">PDFs are rendered as pages for better table/chart understanding</div>
            <div class="upload-formats">
                <span class="format-tag">PDF</span>
                <span class="format-tag">PNG</span>
                <span class="format-tag">JPG</span>
                <span class="format-tag">TXT</span>
            </div>
            <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.txt">
        </div>
        
        <!-- Upload Queue -->
        <div class="section queue" id="queue" style="display: none;">
            <div class="section-title">Upload Queue</div>
            <div id="queueItems"></div>
        </div>
        
        <!-- Text Input -->
        <div class="section">
            <div class="section-title">Or paste text directly</div>
            <div class="text-input-container">
                <div class="text-input-header">
                    <input type="text" id="textTitle" placeholder="Document title (optional)">
                </div>
                <textarea class="text-area" id="textContent" placeholder="Paste or type your content here..."></textarea>
                <div class="text-input-footer">
                    <button class="btn btn-primary" id="submitText" disabled>Add Text</button>
                </div>
            </div>
        </div>
        
        <!-- Recent Documents -->
        <div class="section" id="recentSection" style="display: none;">
            <div class="section-title">Recently Added</div>
            <div class="recent-grid" id="recentGrid"></div>
        </div>
    </main>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
        const API_BASE = window.location.origin;
        
        // State
        let uploadQueue = [];
        let recentDocs = [];
        
        // DOM
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const queueSection = document.getElementById('queue');
        const queueItems = document.getElementById('queueItems');
        const textTitle = document.getElementById('textTitle');
        const textContent = document.getElementById('textContent');
        const submitText = document.getElementById('submitText');
        const recentSection = document.getElementById('recentSection');
        const recentGrid = document.getElementById('recentGrid');
        
        // File type icons
        const icons = {
            pdf: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>`,
            image: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>`,
            text: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8"/></svg>`
        };
        
        // Get file type
        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (ext === 'pdf') return 'pdf';
            if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(ext)) return 'image';
            return 'text';
        }
        
        // Format file size
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${type === 'success' 
                        ? '<path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/>'
                        : '<circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/>'}
                </svg>
                ${message}
            `;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
        
        // Upload zone events
        uploadZone.addEventListener('click', () => fileInput.click());
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            fileInput.value = '';
        });
        
        // Handle file selection
        function handleFiles(files) {
            for (const file of files) {
                addToQueue(file);
            }
            processQueue();
        }
        
        // Add file to queue
        function addToQueue(file) {
            const id = Date.now() + Math.random();
            const item = {
                id,
                file,
                status: 'pending',
                progress: 0,
                message: 'Waiting...'
            };
            uploadQueue.push(item);
            renderQueue();
        }
        
        // Render queue
        function renderQueue() {
            if (uploadQueue.length === 0) {
                queueSection.style.display = 'none';
                return;
            }
            
            queueSection.style.display = 'block';
            queueItems.innerHTML = uploadQueue.map(item => {
                const type = getFileType(item.file.name);
                const statusClass = `status-${item.status}`;
                
                return `
                    <div class="queue-item" data-id="${item.id}">
                        <div class="queue-item-icon ${type}">${icons[type]}</div>
                        <div class="queue-item-info">
                            <div class="queue-item-name">${item.file.name}</div>
                            <div class="queue-item-meta">${formatSize(item.file.size)}</div>
                            ${item.status === 'processing' ? `
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${item.progress}%"></div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="queue-item-status ${statusClass}">
                            ${item.status === 'processing' ? '<div class="spinner"></div>' : ''}
                            <span class="status-text">${item.message || item.status}</span>
                        </div>
                        ${item.status === 'done' || item.status === 'error' ? `
                            <button class="queue-item-remove" onclick="removeFromQueue(${item.id})">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Remove from queue
        function removeFromQueue(id) {
            uploadQueue = uploadQueue.filter(item => item.id !== id);
            renderQueue();
        }
        
        // Update specific item in queue (avoids full re-render)
        function updateItemProgress(id, progress, message) {
            const item = uploadQueue.find(i => i.id === id);
            if (item) {
                item.progress = progress;
                item.message = message;
                
                const el = document.querySelector(`.queue-item[data-id="${id}"]`);
                if (el) {
                    const fill = el.querySelector('.progress-fill');
                    const text = el.querySelector('.status-text');
                    if (fill) fill.style.width = `${progress}%`;
                    if (text) text.textContent = message;
                }
            }
        }

        // Process queue with Streaming Response support
        async function processQueue() {
            const pending = uploadQueue.find(item => item.status === 'pending');
            if (!pending) return;
            
            pending.status = 'processing';
            pending.message = 'Uploading...';
            renderQueue();
            
            try {
                const formData = new FormData();
                formData.append('file', pending.file);
                
                // Use fetch with stream reader
                const response = await fetch(`${API_BASE}/ingest/file`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error(`Server Error: ${response.status}`);

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    
                    // Process all complete lines
                    buffer = lines.pop(); 
                    
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const data = JSON.parse(line);
                            
                            if (data.type === 'progress') {
                                // Update progress bar
                                // Map 0-100% processing to 20-100% total (first 20% is upload)
                                const totalProgress = 20 + (data.value * 0.8);
                                updateItemProgress(pending.id, totalProgress, data.message);
                            } else if (data.type === 'complete') {
                                // Final result
                                pending.status = 'done';
                                pending.message = 'Complete';
                                pending.progress = 100;
                                
                                // Add to recent
                                if (data.docs) {
                                    data.docs.forEach(doc => {
                                        recentDocs.unshift({
                                            ...doc,
                                            filename: pending.file.name
                                        });
                                    });
                                    renderRecent();
                                }
                            } else if (data.type === 'error') {
                                throw new Error(data.message);
                            }
                        } catch (e) {
                            console.log('Non-JSON chunk:', line);
                        }
                    }
                }
                
                // If we finished stream without explicit complete message (legacy backend support)
                if (pending.status === 'processing') {
                    pending.status = 'done';
                    pending.message = 'Complete';
                    pending.progress = 100;
                }
                
                renderQueue();
                showToast(`${pending.file.name} ingested successfully`);
                
            } catch (error) {
                console.error(error);
                pending.status = 'error';
                pending.message = error.message || 'Failed';
                renderQueue();
                showToast(`Failed to ingest ${pending.file.name}`, 'error');
            }
            
            processQueue(); // Process next
        }
        
        // Text input
        textContent.addEventListener('input', () => {
            submitText.disabled = !textContent.value.trim();
        });
        
        submitText.addEventListener('click', async () => {
            const content = textContent.value.trim();
            if (!content) return;
            
            submitText.disabled = true;
            submitText.textContent = 'Adding...';
            
            try {
                const response = await fetch(`${API_BASE}/ingest/text`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: content,
                        title: textTitle.value.trim() || null
                    })
                });
                
                if (!response.ok) throw new Error('Failed to add text');
                
                const doc = await response.json();
                recentDocs.unshift({
                    ...doc,
                    filename: textTitle.value.trim() || 'Text Document'
                });
                renderRecent();
                
                textContent.value = '';
                textTitle.value = '';
                showToast('Text added to knowledge base');
                
            } catch (error) {
                showToast('Failed to add text', 'error');
            }
            
            submitText.disabled = true;
            submitText.textContent = 'Add Text';
        });
        
        // Render recent documents
        function renderRecent() {
            if (recentDocs.length === 0) {
                recentSection.style.display = 'none';
                return;
            }
            
            recentSection.style.display = 'block';
            recentGrid.innerHTML = recentDocs.slice(0, 6).map(doc => `
                <div class="recent-card">
                    ${doc.url ? `<img src="${doc.url}" class="recent-card-image" alt="">` : ''}
                    <div class="recent-card-content">
                        <div class="recent-card-type">${doc.type}</div>
                        <div class="recent-card-title">${doc.filename || doc.id.slice(0, 8)}</div>
                        ${doc.caption ? `<div class="recent-card-caption">${doc.caption}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
